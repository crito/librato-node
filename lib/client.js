// Generated by CoffeeScript 1.7.1
(function() {
  var Client, Q, packageJson, request, util;

  request = require('request');

  Q = require('q');

  util = require('util');

  packageJson = require('../package.json');

  Client = (function() {
    Client.prototype.endpoint = 'https://metrics-api.librato.com/v1';

    function Client(_arg) {
      var email, token;
      email = _arg.email, token = _arg.token;
      if (!email || !token) {
        console.warn("librato-node metrics disabled: no email or token provided.");
      } else {
        this._authHeader = 'Basic ' + new Buffer("" + email + ":" + token).toString('base64');
      }
    }

    Client.prototype.send = function(json, cb) {
      var deferred, requestOptions;
      if (!this._authHeader) {
        return;
      }
      requestOptions = {
        method: 'POST',
        uri: "" + this.endpoint + "/metrics",
        json: json,
        headers: {
          authorization: this._authHeader,
          'user-agent': 'librato-node/' + packageJson.version
        }
      };
      deferred = Q.defer();
      request(requestOptions, function(err, res, body) {
        if (err != null) {
          return deferred.reject(err);
        }
        if (res.statusCode > 399 || ((body != null ? body.errors : void 0) != null)) {
          return deferred.reject(new Error("Error sending to Librato: " + (util.inspect(body)) + " (statusCode: " + res.statusCode + ")"));
        } else {
          return deferred.resolve(body);
        }
      });
      return deferred.promise;
    };

    return Client;

  })();

  module.exports = Client;

}).call(this);
